id: required-package/instana-agent-operator # unique source id
# "" -> no filter - this is a producer and only cares about the empty state
kindFilter: ""
task:
  # EditTask is the simple set of edits
  editTask:
    edits:
      # I want to instal instana-agent-operator at version <=2.0.5
      - type: VariableEdit
        action: Add
        variableId: required-package/instana-agent-operator
        kind: olm.variable.required-package
        params:
          properties:
            olm.package.name: instana-agent-operator
            olm.package.version: <=2.0.5
            olm.package.channel: stable
  taskType: EditTask
---
id: required-package/:add-mandatory
kindFilter: olm.variable.required-package
task:
  editTask:
    edits:
      - action: Add
        constraintType: Mandatory
        kind: olm.variable.required-package
        type: ConstraintEdit
        variableId: '{{ curVar.VariableID }}'
  taskType: EditTask

---
id: required-package/:bundles
kindFilter: olm.variable.required-package
task:
  taskType: Template
  templateTask:
    template:
      for:
        do:
          doType: DoEdits
          edits:
            edits:
              - action: Upsert
                kind: olm.variable.bundle
                params:
                  properties:
                    olm.bundle.id: '{{ bundle.BundleID }}'
                    olm.bundle.image: '{{ bundle.BundlePath }}'
                    olm.gvk.provided: '{{ bundle.ProvidedApis }}'
                    olm.gvk.required: '{{ bundle.RequiredApis }}'
                    olm.package.channel: '{{ bundle.ChannelName }}'
                    olm.package.defaultChannel: '{{ bundle.DefaultChannelName }}'
                    olm.package.name: '{{ bundle.PackageName }}'
                    olm.package.required: '{{ bundle.PackageDependencies }}'
                    olm.package.version: '{{ bundle.Version }}'
                type: VariableEdit
                variableId: 'olm-bundle/{{ bundle.BundleID }}'
        query: '{{ getBundlesForPackage(curVar.Property("olm.package.name"), curVar.Property("olm.package.version"),
          curVar.Property("olm.package.channel")) }}'
        variable: bundle

---
id: required-package/:bundle-dependencies
kindFilter: olm.variable.bundle
task:
  editTask:
    edits:
      - action: Add
        constraintId: required-package/{{ curVar.Property("olm.package.name") }}
        constraintType: Dependency
        kind: olm.variable.required-package
        params:
          dependentVariableId: '{{ curVar.VariableID }}'
          orderPreference: 'multiSort(weightedCompare([v1.Properties["olm.package.defaultChannel"]], v2.Properties["olm.package.channel"], v1.Properties["olm.package.channel"]), -1*semverCompare(v1.Properties["olm.package.version"], v2.Properties["olm.package.version"])) < 0'
        type: ConstraintEdit
        variableId: 'required-package/{{ curVar.Property("olm.package.name") }}'
  taskType: EditTask

---
id: bundle/:bundle-dependencies
kindFilter: olm.variable.bundle
task:
  taskType: Template
  templateTask:
    template:
      for:
        do:
          doType: DoFor
          for:
            do:
              doType: DoEdits
              edits:
                edits:
                  - action: Upsert
                    kind: olm.variable.bundle
                    params:
                      properties:
                        olm.bundle.id: '{{ bundle.BundleID }}'
                        olm.bundle.image: '{{ bundle.BundlePath }}'
                        olm.gvk.provided: '{{ bundle.ProvidedApis }}'
                        olm.gvk.required: '{{ bundle.RequiredApis }}'
                        olm.package.channel: '{{ bundle.ChannelName }}'
                        olm.package.defaultChannel: '{{ bundle.DefaultChannelName
                        }}'
                        olm.package.name: '{{ bundle.PackageName }}'
                        olm.package.required: '{{ bundle.PackageDependencies }}'
                        olm.package.version: '{{ bundle.Version }}'
                    type: VariableEdit
                    variableId: 'olm-bundle/{{ bundle.BundleID }}'
                  - action: Add
                    constraintId: 'required-package/{{ bundle.PackageName }}'
                    constraintType: Dependency
                    kind: olm.variable.bundle
                    params:
                      dependentVariableId: 'olm-bundle/{{ bundle.BundleID }}'
                      orderPreference: 'multiSort(weightedCompare([v1.Properties["olm.package.defaultChannel"]], v2.Properties["olm.package.channel"], v1.Properties["olm.package.channel"]), -1*semverCompare(v1.Properties["olm.package.version"], v2.Properties["olm.package.version"])) < 0'
                    type: ConstraintEdit
                    variableId: '{{ curVar.VariableID }}'
            query: '{{ getBundlesForPackage(packageDependency.PackageName, packageDependency.Version,
              "") }}'
            variable: bundle
        query: '{{ curVar.Property("olm.package.required") }}'
        variable: packageDependency

---
id: bundle/:gvk-dependencies
kindFilter: olm.variable.bundle
task:
  taskType: Template
  templateTask:
    template:
      for:
        do:
          doType: DoFor
          for:
            do:
              doType: DoEdits
              edits:
                edits:
                  - action: Upsert
                    kind: olm.variable.bundle
                    params:
                      properties:
                        olm.bundle.id: '{{ bundle.BundleID }}'
                        olm.bundle.image: '{{ bundle.BundlePath }}'
                        olm.gvk.provided: '{{ bundle.ProvidedApis }}'
                        olm.gvk.required: '{{ bundle.RequiredApis }}'
                        olm.package.channel: '{{ bundle.ChannelName }}'
                        olm.package.defaultChannel: '{{ bundle.DefaultChannelName
                        }}'
                        olm.package.name: '{{ bundle.PackageName }}'
                        olm.package.required: '{{ bundle.PackageDependencies }}'
                        olm.package.version: '{{ bundle.Version }}'
                    type: VariableEdit
                    variableId: 'olm-bundle/{{ bundle.BundleID }}'
                  - action: Add
                    constraintId: 'required-gvk/{{ gvk.Group }}:{{ gvk.Version }}:{{gvk.Kind }}'
                    constraintType: Dependency
                    kind: olm.variable.bundle
                    params:
                      dependentVariableId: 'olm-bundle/{{ bundle.BundleID }}'
                      orderPreference: 'semverCompare(v1.Properties["olm.package.version"], v2.Properties["olm.package.version"]) > 0'
                    type: ConstraintEdit
                    variableId: '{{ curVar.VariableID }}'
            query: '{{ getBundlesForGVK(gvk.Group, gvk.Version, gvk.Kind) }}'
            variable: bundle
        query: '{{ curVar.Property("olm.gvk.required") }}'
        variable: gvk

---
id: uniqueness/:package
kindFilter: olm.variable.bundle
task:
  editTask:
    edits:
      - action: Upsert
        kind: olm.variable.uniqueness
        type: VariableEdit
        variableId: package-uniqueness
      - action: Add
        constraintId: 'package-uniqueness/{{ curVar.Property("olm.package.name") }}'
        constraintType: AtMost
        kind: olm.variable.uniqueness
        params:
          "n": 1
          orderPreference: 'semverCompare(v1.Properties["olm.package.version"], v2.Properties["olm.package.version"])> 0'
          variableId: '{{ curVar.VariableID }}'
        type: ConstraintEdit
        variableId: package-uniqueness
  taskType: EditTask

---
id: uniqueness/:gvk
kindFilter: olm.variable.bundle
task:
  taskType: Template
  templateTask:
    template:
      for:
        do:
          doType: DoEdits
          edits:
            edits:
              - action: Upsert
                kind: olm.variable.uniqueness
                type: VariableEdit
                variableId: gvk-uniqueness
              - action: Add
                constraintId: 'gvk-uniqueness/{{ gvk.Group }}:{{ gvk.Version }}:{{gvk.Kind }}'
                constraintType: AtMost
                kind: olm.variable.uniqueness
                params:
                  "n": 1
                  orderPreference: 'semverCompare(v1.Properties["olm.package.version"], v2.Properties["olm.package.version"]) > 0'
                  variableId: '{{ curVar.VariableID }}'
                type: ConstraintEdit
                variableId: gvk-uniqueness
        query: '{{ curVar.Property("olm.gvk.provided") }}'
        variable: gvk